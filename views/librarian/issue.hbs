<div class="container mt-4">
  <h1 class="mb-4 text-primary">Выдача книг читателям</h1>
  
  <!-- Поиск читателя -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">1. Выбор читателя</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="readerSearch" class="form-label">Поиск читателя:</label>
          <input type="text" class="form-control" id="readerSearch" 
                 placeholder="Введите имя или email читателя">
          <div id="readerResults" class="mt-2"></div>
        </div>
        <div class="col-md-6">
          <div id="selectedReader" class="p-3 border rounded" style="display: none;">
            <h6>Выбранный читатель:</h6>
            <div id="readerInfo"></div>
            <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="clearReader()">
              Отменить выбор
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Брони читателя -->
  <div class="card shadow-sm mb-4" id="readerReservationsCard" style="display: none;">
    <div class="card-body">
      <h5 class="card-title mb-3">2. Брони читателя</h5>
      <div id="reservationsList" class="mb-3">
        <div class="text-center py-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
          </div>
          <p class="mt-2 text-muted">Загрузка броней...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Фильтры книг -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">3. Выбор дополнительных книг</h5>
      <form method="GET" action="/librarian/issue">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label for="title" class="form-label">Название:</label>
            <input type="text" class="form-control" id="title" name="title" value="{{filters.title}}" 
                   placeholder="Введите название книги">
          </div>
          
          <div class="col-md-3">
            <label for="author" class="form-label">Автор:</label>
            <input type="text" class="form-control" id="author" name="author" value="{{filters.author}}" 
                   placeholder="Выберите автора" list="authors-list">
            <datalist id="authors-list">
              {{#each authors}}
                <option value="{{this}}">
              {{/each}}
            </datalist>
          </div>
          
          <div class="col-md-3">
            <label for="genre" class="form-label">Жанр:</label>
            <select class="form-select" id="genre" name="genre">
              <option value="">Все жанры</option>
              {{#each genres}}
                <option value="{{this}}" {{#if (eq this ../filters.genre)}}selected{{/if}}>
                  {{this}}
                </option>
              {{/each}}
            </select>
          </div>
          
          <div class="col-md-3">
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary">Применить фильтры</button>
              <a href="/librarian/issue" class="btn btn-outline-secondary">Сбросить</a>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Выбранные книги -->
  <div class="card shadow-sm mb-4" id="selectedBooksCard" style="display: none;">
    <div class="card-body">
      <h5 class="card-title mb-3">Итоговый список для выдачи</h5>
      <div id="selectedItemsList" class="mb-3"></div>
      <div class="row">
        <div class="col-md-3">
          <label for="loanDays" class="form-label">Срок выдачи (дней):</label>
          <input type="number" class="form-control" id="loanDays" value="30" min="1" max="365">
        </div>
        <div class="col-md-9 d-flex align-items-end">
          <button type="button" class="btn btn-success btn-lg" onclick="issueBooks()">
            Оформить выдачу
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Сетка книг -->
  <div class="row g-4 mb-4">
    {{#each books}}
      <div class="col-xl-3 col-lg-4 col-md-6">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <div class="text-center mb-3">
              {{#if this.cover_image_url}}
                <img src="{{this.cover_image_url}}" class="img-fluid rounded" alt="{{this.title}}" style="max-height: 150px;">
              {{else}}
                <img src="/images/covers/default.png" class="img-fluid" alt="{{this.title}}" style="max-height: 150px;">
              {{/if}}
            </div>
            
            <h6 class="card-title text-primary">{{this.title}}</h6>
            <div class="card-text">
              <p class="mb-1"><small><strong>Авторы:</strong> {{this.authors}}</small></p>
              <p class="mb-1"><small><strong>Жанры:</strong> {{this.genres}}</small></p>
              <p class="mb-1"><small><strong>Страниц:</strong> {{this.page_count}}</small></p>
              <p class="mb-3">
                <small class="{{#if (gt this.quantity 0)}}text-success{{else}}text-danger{{/if}}">
                  <strong>Доступно:</strong> {{this.quantity}} шт.
                </small>
              </p>
              
              {{#if (gt this.quantity 0)}}
                <button type="button" class="btn btn-sm btn-outline-primary w-100" 
                        onclick="selectBook({{this.id}}, '{{this.title}}', '{{this.authors}}', null)">
                  Выбрать для выдачи
                </button>
              {{else}}
                <button class="btn btn-sm btn-secondary w-100" disabled>Недоступно</button>
              {{/if}}
            </div>
          </div>
        </div>
      </div>
    {{else}}
      <div class="col-12">
        <div class="text-center py-5 text-muted">
          <p>Книги не найдены. Попробуйте изменить параметры фильтрации.</p>
        </div>
      </div>
    {{/each}}
  </div>
  
  <!-- Пагинация -->
  {{#if (gt totalPages 1)}}
    <nav>
      <ul class="pagination justify-content-center">
        {{#if (gt currentPage 1)}}
          <li class="page-item">
            <a class="page-link" href="/librarian/issue?page={{sub currentPage 1}}">← Назад</a>
          </li>
        {{/if}}
        
        {{#each (range 1 totalPages)}}
          {{#if (eq this ../currentPage)}}
            <li class="page-item active">
              <span class="page-link">{{this}}</span>
            </li>
          {{else}}
            <li class="page-item">
              <a class="page-link" href="/librarian/issue?page={{this}}">{{this}}</a>
            </li>
          {{/if}}
        {{/each}}
        
        {{#if (lt currentPage totalPages)}}
          <li class="page-item">
            <a class="page-link" href="/librarian/issue?page={{add currentPage 1}}">Вперед →</a>
          </li>
        {{/if}}
      </ul>
    </nav>
  {{/if}}
</div>

{{#section 'scripts'}}
<script>
  let selectedReader = null;
  let selectedBooks = new Map(); // {bookId: {title, authors, isReservation: false}}
  let selectedReservations = new Map(); // {reservationId: {title, authors, bookId, isReservation: true}}
  let readerReservations = [];

  document.addEventListener('DOMContentLoaded', function() {
    const savedReader = sessionStorage.getItem('selectedReader');
    if (savedReader) {
      selectedReader = JSON.parse(savedReader);
      updateReaderDisplay();
      loadReaderReservations();
    }

    const savedBooks = sessionStorage.getItem('selectedBooks');
    if (savedBooks) {
      const booksArray = JSON.parse(savedBooks);
      selectedBooks = new Map(booksArray);
    }

    const savedReservations = sessionStorage.getItem('selectedReservations');
    if (savedReservations) {
      const reservationsArray = JSON.parse(savedReservations);
      selectedReservations = new Map(reservationsArray);
    }

    updateSelectedItemsList();
    updateIssueButton();
  });

  // Поиск читателей
  document.getElementById('readerSearch').addEventListener('input', function(e) {
    const query = e.target.value.trim();
    const resultsDiv = document.getElementById('readerResults');
    
    if (query.length < 2) {
      resultsDiv.innerHTML = '';
      return;
    }
    
    fetch(`/librarian/api/readers?q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(readers => {
        resultsDiv.innerHTML = '';
        readers.forEach(reader => {
          const div = document.createElement('div');
          div.className = 'border p-2 mb-2 rounded cursor-pointer';
          div.innerHTML = `
            <strong>${reader.name}</strong><br>
            <small>${reader.email}</small>
          `;
          div.style.cursor = 'pointer';
          div.onclick = () => selectReader(reader);
          resultsDiv.appendChild(div);
        });
      });
  });

  function selectReader(reader) {
    selectedReader = reader;
    document.getElementById('readerSearch').value = '';
    document.getElementById('readerResults').innerHTML = '';
    
    sessionStorage.setItem('selectedReader', JSON.stringify(reader));
    sessionStorage.removeItem('selectedReservations');
    selectedReservations.clear();
    
    updateReaderDisplay();
    loadReaderReservations();
    updateSelectedItemsList();
    updateIssueButton();
  }

  function updateReaderDisplay() {
    if (selectedReader) {
      document.getElementById('readerInfo').innerHTML = `
        <strong>${selectedReader.name}</strong><br>
        <small>${selectedReader.email}</small>
      `;
      document.getElementById('selectedReader').style.display = 'block';
      document.getElementById('readerReservationsCard').style.display = 'block';
    } else {
      document.getElementById('selectedReader').style.display = 'none';
      document.getElementById('readerReservationsCard').style.display = 'none';
    }
  }

  function clearReader() {
    selectedReader = null;
    readerReservations = [];
    sessionStorage.removeItem('selectedReader');
    sessionStorage.removeItem('selectedReservations');
    selectedReservations.clear();
    
    updateReaderDisplay();
    updateSelectedItemsList();
    updateIssueButton();
  }

  async function loadReaderReservations() {
    if (!selectedReader) return;
    
    const reservationsList = document.getElementById('reservationsList');
    reservationsList.innerHTML = `
      <div class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Загрузка...</span>
        </div>
        <p class="mt-2 text-muted">Загрузка броней...</p>
      </div>
    `;
    
    try {
      const response = await fetch(`/reservations/api/readers/${selectedReader.id}`);
      readerReservations = await response.json();
      
      if (readerReservations.length === 0) {
        reservationsList.innerHTML = `
          <div class="text-center py-4">
            <p class="text-muted">У читателя нет активных броней</p>
          </div>
        `;
        return;
      }
      
      displayReservations();
    } catch (error) {
      console.error('Error loading reservations:', error);
      reservationsList.innerHTML = `
        <div class="alert alert-danger">
          Ошибка при загрузке броней
        </div>
      `;
    }
  }

  function displayReservations() {
    const reservationsList = document.getElementById('reservationsList');
    reservationsList.innerHTML = '';
    
    readerReservations.forEach(reservation => {
      const isSelected = selectedReservations.has(reservation.reservation_id);
      const isExpired = new Date(reservation.reserved_until) < new Date();
      
      const div = document.createElement('div');
      div.className = `d-flex justify-content-between align-items-center border p-3 mb-3 rounded ${isExpired ? 'border-danger' : ''}`;
      div.innerHTML = `
        <div style="flex: 1;">
          <div class="d-flex align-items-start">
            ${reservation.cover_image_url ? 
              `<img src="${reservation.cover_image_url}" class="img-fluid rounded me-3" alt="${reservation.title}" style="max-height: 60px; max-width: 45px;">` : 
              `<img src="/images/covers/default.png" class="img-fluid rounded me-3" alt="${reservation.title}" style="max-height: 60px; max-width: 45px;">`
            }
            <div>
              <h6 class="mb-1 ${isExpired ? 'text-danger' : 'text-primary'}">${reservation.title}</h6>
              <p class="mb-1"><small><strong>Авторы:</strong> ${reservation.authors}</small></p>
              <p class="mb-1"><small><strong>Жанры:</strong> ${reservation.genres}</small></p>
              <p class="mb-0 ${isExpired ? 'text-danger' : ''}">
                <small><strong>Бронирование до:</strong> ${new Date(reservation.reserved_until).toLocaleDateString('ru-RU')}</small>
                ${isExpired ? '<span class="badge bg-danger ms-1">Истекло</span>' : ''}
              </p>
            </div>
          </div>
        </div>
        <div class="ms-3">
          <button type="button" class="btn btn-sm ${isSelected ? 'btn-success' : 'btn-outline-primary'}" 
                  onclick="toggleReservation(${reservation.reservation_id}, ${reservation.book_id}, '${reservation.title.replace(/'/g, "\\'")}', '${reservation.authors.replace(/'/g, "\\'")}')">
            ${isSelected ? '✓ Выбрано' : 'Выбрать'}
          </button>
        </div>
      `;
      reservationsList.appendChild(div);
    });
  }

  function toggleReservation(reservationId, bookId, title, authors) {
    if (selectedReservations.has(reservationId)) {
      selectedReservations.delete(reservationId);
    } else {
      selectedReservations.set(reservationId, {
        bookId,
        title,
        authors,
        isReservation: true
      });
    }
    
    sessionStorage.setItem('selectedReservations', JSON.stringify(Array.from(selectedReservations.entries())));
    displayReservations();
    updateSelectedItemsList();
    updateIssueButton();
  }

  // Выбор обычных книг
  function selectBook(bookId, title, authors) {
    if (selectedBooks.has(bookId)) {
      selectedBooks.delete(bookId);
    } else {
      selectedBooks.set(bookId, {
        title,
        authors,
        isReservation: false
      });
    }
    
    sessionStorage.setItem('selectedBooks', JSON.stringify(Array.from(selectedBooks.entries())));
    updateSelectedItemsList();
    updateIssueButton();
  }

  function updateSelectedItemsList() {
    const listDiv = document.getElementById('selectedItemsList');
    const card = document.getElementById('selectedBooksCard');
    
    const totalItems = selectedReservations.size + selectedBooks.size;
    
    if (totalItems === 0) {
      card.style.display = 'none';
      return;
    }
    
    card.style.display = 'block';
    listDiv.innerHTML = '';
    
    // Показываем брони
    selectedReservations.forEach((item, reservationId) => {
      const div = document.createElement('div');
      div.className = 'd-flex justify-content-between align-items-center border p-2 mb-2 rounded bg-light';
      div.innerHTML = `
        <div>
          <span class="badge bg-info me-2">Бронь</span>
          <strong>${item.title}</strong><br>
          <small>${item.authors}</small>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger" 
                onclick="toggleReservation(${reservationId}, ${item.bookId}, '${item.title.replace(/'/g, "\\'")}', '${item.authors.replace(/'/g, "\\'")}')">
          Удалить
        </button>
      `;
      listDiv.appendChild(div);
    });
    
    // Показываем обычные книги
    selectedBooks.forEach((item, bookId) => {
      const div = document.createElement('div');
      div.className = 'd-flex justify-content-between align-items-center border p-2 mb-2 rounded';
      div.innerHTML = `
        <div>
          <strong>${item.title}</strong><br>
          <small>${item.authors}</small>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger" 
                onclick="selectBook(${bookId}, '${item.title.replace(/'/g, "\\'")}', '${item.authors.replace(/'/g, "\\'")}')">
          Удалить
        </button>
      `;
      listDiv.appendChild(div);
    });
    
    // Показываем итоговую статистику
    const statsDiv = document.createElement('div');
    statsDiv.className = 'mt-3 p-2 border-top';
    statsDiv.innerHTML = `
      <p class="mb-0">
        <strong>Итого:</strong> ${totalItems} книг 
        ${selectedReservations.size > 0 ? `<span class="badge bg-info ms-2">${selectedReservations.size} броней</span>` : ''}
        ${selectedBooks.size > 0 ? `<span class="badge bg-primary ms-2">${selectedBooks.size} обычных</span>` : ''}
      </p>
    `;
    listDiv.appendChild(statsDiv);
  }

  function updateIssueButton() {
    const canIssue = selectedReader && (selectedReservations.size > 0 || selectedBooks.size > 0);
    const issueButton = document.querySelector('button[onclick="issueBooks()"]');
    if (issueButton) {
      issueButton.disabled = !canIssue;
    }
  }

  async function issueBooks() {
    if (!selectedReader || (selectedReservations.size === 0 && selectedBooks.size === 0)) return;
    
    const loanDays = document.getElementById('loanDays').value || 30;
    const bookIds = Array.from(selectedBooks.keys());
    const reservationIds = Array.from(selectedReservations.keys());
    
    try {
      const response = await fetch('/librarian/issue', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          readerId: selectedReader.id,
          bookIds: bookIds.length > 0 ? bookIds : undefined,
          reservationIds: reservationIds.length > 0 ? reservationIds : undefined,
          loanDays: loanDays
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        showNotification(result.message, 'success');
        // Сброс формы
        selectedReader = null;
        selectedBooks.clear();
        selectedReservations.clear();
        readerReservations = [];
        sessionStorage.removeItem('selectedReader');
        sessionStorage.removeItem('selectedBooks');
        sessionStorage.removeItem('selectedReservations');
        
        clearReader();
        updateSelectedItemsList();
        updateIssueButton();
        
        // Обновляем страницу через 2 секунды
        setTimeout(() => {
          window.location.href = '/librarian/issue';
        }, 2000);
      } else {
        showNotification('Ошибка: ' + result.message, 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('Произошла ошибка при оформлении выдачи', 'error');
    }
  }

  // Обработка отправки формы фильтров
  document.querySelector('form[action="/librarian/issue"]').addEventListener('submit', function(e) {
    if (selectedReader) {
      sessionStorage.setItem('selectedReader', JSON.stringify(selectedReader));
    }
    if (selectedBooks.size > 0) {
      sessionStorage.setItem('selectedBooks', JSON.stringify(Array.from(selectedBooks.entries())));
    }
    if (selectedReservations.size > 0) {
      sessionStorage.setItem('selectedReservations', JSON.stringify(Array.from(selectedReservations.entries())));
    }
  });
</script>
{{/section}}