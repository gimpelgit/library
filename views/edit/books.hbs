<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-primary">Редактирование книг</h1>
    <a href="/edit" class="btn btn-outline-secondary">← Назад</a>
  </div>
  
  <!-- Поиск и добавление -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-9">
          <form method="GET" action="/edit/books" class="row g-2">
            <div class="col-md-4">
              <label for="search" class="form-label">Поиск по названию:</label>
              <input type="text" class="form-control" id="search" name="search" 
                     value="{{filters.search}}" placeholder="Название книги">
            </div>
            <div class="col-md-3">
              <label for="author" class="form-label">Автор:</label>
              <input type="text" class="form-control" id="author" name="author" 
                     value="{{filters.author}}" placeholder="Автор">
            </div>
            <div class="col-md-3">
              <label for="genre" class="form-label">Жанр:</label>
              <select class="form-select" id="genre" name="genre">
                <option value="">Все жанры</option>
                {{#each genres}}
                  <option value="{{this.name}}" {{#if (eq this.name ../filters.genre)}}selected{{/if}}>
                    {{this.name}}
                  </option>
                {{/each}}
              </select>
            </div>
            <div class="col-md-2">
              <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary">Поиск</button>
                <a href="/edit/books" class="btn btn-outline-secondary">Сбросить</a>
              </div>
            </div>
          </form>
        </div>
        <div class="col-md-3">
          <button type="button" class="btn btn-success w-100" onclick="window.location.href='/edit/books/edit/new'">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            Добавить книгу
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Таблица книг -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Обложка</th>
              <th>Название</th>
              <th>Авторы</th>
              <th>Жанры</th>
              <th>Страниц</th>
              <th>Количество</th>
              <th class="text-end">Действия</th>
            </tr>
          </thead>
          <tbody>
            {{#each books}}
              <tr id="book-row-{{this.id}}">
                <td>{{this.id}}</td>
                <td>
                  {{#if this.cover_image_url}}
                    <img src="{{this.cover_image_url}}" class="img-fluid rounded" alt="{{this.title}}" 
                         style="max-height: 60px; max-width: 45px;">
                  {{else}}
                    <img src="/images/covers/default.png" class="img-fluid" alt="{{this.title}}"
                         style="max-height: 60px; max-width: 45px;">
                  {{/if}}
                </td>
                <td>
                  <strong class="text-primary">{{this.title}}</strong><br>
                  <small class="text-muted">{{truncate this.summary 50}}</small>
                </td>
                <td>
                  <small>{{formatFIO this.author_names}}</small>
                </td>
                <td>
                  <small>{{this.genre_names}}</small>
                </td>
                <td>{{this.page_count}}</td>
                <td>
                  <span class="badge {{#if (gt this.quantity 0)}}bg-success{{else}}bg-danger{{/if}}">
                    {{this.quantity}}
                  </span>
                </td>
                <td class="text-end">
                  <button type="button" class="btn btn-sm btn-outline-primary me-2" 
                          onclick="window.location.href='/edit/books/edit/{{this.id}}'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                    </svg>
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-danger" 
                          onclick="deleteBook({{this.id}}, '{{this.title}}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                      <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                  </button>
                </td>
              </tr>
            {{else}}
              <tr>
                <td colspan="8" class="text-center py-4 text-muted">
                  {{#if filters.search}}
                    Книги не найдены
                  {{else}}
                    Нет книг. Добавьте первую книгу.
                  {{/if}}
                </td>
              </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Пагинация -->
  {{#if (gt totalPages 1)}}
    <nav class="mt-4">
      <ul class="pagination justify-content-center">
        {{#if (gt currentPage 1)}}
          <li class="page-item">
            <a class="page-link" href="/edit/books?page={{sub currentPage 1}}{{#if filters.search}}&search={{filters.search}}{{/if}}{{#if filters.author}}&author={{filters.author}}{{/if}}{{#if filters.genre}}&genre={{filters.genre}}{{/if}}">← Назад</a>
          </li>
        {{/if}}
        
        {{#each (range 1 totalPages)}}
          {{#if (eq this ../currentPage)}}
            <li class="page-item active">
              <span class="page-link">{{this}}</span>
            </li>
          {{else}}
            <li class="page-item">
              <a class="page-link" href="/edit/books?page={{this}}{{#if ../filters.search}}&search={{../filters.search}}{{/if}}{{#if ../filters.author}}&author={{../filters.author}}{{/if}}{{#if ../filters.genre}}&genre={{../filters.genre}}{{/if}}">{{this}}</a>
            </li>
          {{/if}}
        {{/each}}
        
        {{#if (lt currentPage totalPages)}}
          <li class="page-item">
            <a class="page-link" href="/edit/books?page={{add currentPage 1}}{{#if filters.search}}&search={{filters.search}}{{/if}}{{#if filters.author}}&author={{filters.author}}{{/if}}{{#if filters.genre}}&genre={{filters.genre}}{{/if}}">Вперед →</a>
          </li>
        {{/if}}
      </ul>
    </nav>
  {{/if}}
</div>

<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="deleteBookModal" tabindex="-1" aria-labelledby="deleteBookModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger" id="deleteBookModalLabel">Удаление книги</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Вы действительно хотите удалить книгу?</p>
        <div class="p-3 bg-light rounded">
          <p class="mb-1"><strong>Книга:</strong> <span id="deleteBookTitle"></span></p>
          <p class="mb-0 text-danger">
            <small>Внимание: удаление книги невозможно, если она выдана или забронирована.</small>
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBookBtn">Удалить</button>
      </div>
    </div>
  </div>
</div>

{{#section 'scripts'}}
<script>
  let currentBookId = null;

  function deleteBook(id, title) {
    currentBookId = id;
    document.getElementById('deleteBookTitle').textContent = title;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteBookModal'));
    modal.show();
  }
  
  document.getElementById('confirmDeleteBookBtn').addEventListener('click', async function() {
    if (!currentBookId) return;
    
    try {
      const response = await fetch(`/edit/books/${currentBookId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteBookModal'));
        modal.hide();
        
        const row = document.getElementById(`book-row-${currentBookId}`);
        if (row) row.remove();
        
        showNotification(result.message, 'success');
      } else {
        showNotification('Ошибка: ' + result.message, 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('Произошла ошибка при удалении книги', 'error');
    }
  });
</script>
{{/section}}